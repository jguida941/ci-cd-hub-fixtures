# ============================================================================
# CI/CD Hub - Python CI Caller Template
# ============================================================================
# Copy this file to your repo: .github/workflows/hub-python-ci.yml
# All inputs can be overridden via workflow_dispatch.
#
# For monorepos: set workdir to the subfolder containing your Python project.
#
# NOTE: Update the @ref below to match your desired hub version:
#   - Use @v1 (recommended) for stable releases
#   - Use @main for latest (may have breaking changes)
#
# To run on push/PR, add triggers and hardcode your preferred defaults.
# ============================================================================

name: "Hub: Python CI"

# ============================================================================
# DISPATCH INPUTS: Tool toggles only (booleans)
# THRESHOLDS: Set in .ci-hub.yml or edit defaults below
# See ADR-0024 for rationale (GitHub 25-input limit)
# ============================================================================

on:
  workflow_dispatch:
    inputs:
      # ---- Essential Settings ----
      python_version:
        description: 'Python version'
        type: string
        default: '3.12'
      workdir:
        description: 'Working directory (for monorepos)'
        type: string
        default: '.'
      hub_correlation_id:
        description: 'Correlation ID (set by orchestrator)'
        type: string
        default: ''

      # ---- Tool Toggles (booleans only) ----
      run_pytest:
        description: 'Run pytest'
        type: boolean
        default: true
      run_ruff:
        description: 'Run Ruff linter'
        type: boolean
        default: true
      run_bandit:
        description: 'Run Bandit'
        type: boolean
        default: true
      run_pip_audit:
        description: 'Run pip-audit'
        type: boolean
        default: true
      run_mypy:
        description: 'Run mypy'
        type: boolean
        default: false
      run_black:
        description: 'Run Black'
        type: boolean
        default: true
      run_isort:
        description: 'Run isort'
        type: boolean
        default: true
      run_mutmut:
        description: 'Run mutmut mutation testing'
        type: boolean
        default: true
      run_hypothesis:
        description: 'Run Hypothesis property-based testing'
        type: boolean
        default: true
      run_semgrep:
        description: 'Run Semgrep SAST'
        type: boolean
        default: false
      run_trivy:
        description: 'Run Trivy container scan'
        type: boolean
        default: false
      run_codeql:
        description: 'Run CodeQL analysis'
        type: boolean
        default: false
      run_docker:
        description: 'Run Docker integration tests'
        type: boolean
        default: false

      # ---- Threshold Override ----
      threshold_overrides_yaml:
        description: 'YAML string with threshold overrides'
        type: string
        default: ''

      # ---- NOTE: Thresholds not in dispatch ----
      # To customize thresholds, edit the defaults in the 'with:' block below
      # or set them in your .ci-hub.yml (see docs/guides/ONBOARDING.md)

# Required permissions for reusable workflow features
permissions:
  contents: read
  security-events: write  # For CodeQL (must be declared even if disabled)
  actions: read

jobs:
  ci:
    uses: jguida941/ci-cd-hub/.github/workflows/python-ci.yml@v1
    with:
      # ---- From dispatch inputs ----
      python_version: ${{ inputs.python_version }}
      workdir: ${{ inputs.workdir }}
      hub_correlation_id: ${{ inputs.hub_correlation_id }}

      # ---- Tool toggles (from dispatch) ----
      run_pytest: ${{ inputs.run_pytest }}
      run_ruff: ${{ inputs.run_ruff }}
      run_bandit: ${{ inputs.run_bandit }}
      run_pip_audit: ${{ inputs.run_pip_audit }}
      run_mypy: ${{ inputs.run_mypy }}
      run_black: ${{ inputs.run_black }}
      run_isort: ${{ inputs.run_isort }}
      run_mutmut: ${{ inputs.run_mutmut }}
      run_hypothesis: ${{ inputs.run_hypothesis }}
      run_semgrep: ${{ inputs.run_semgrep }}
      run_trivy: ${{ inputs.run_trivy }}
      run_codeql: ${{ inputs.run_codeql }}
      run_docker: ${{ inputs.run_docker }}

      # ---- Threshold Override ----
      threshold_overrides_yaml: ${{ inputs.threshold_overrides_yaml }}

      # ---- Thresholds (edit these defaults or set in .ci-hub.yml) ----
      coverage_min: 70
      mutation_score_min: 70
      max_critical_vulns: 0
      max_high_vulns: 0
      max_semgrep_findings: 0
      max_black_issues: 0
      max_isort_issues: 0
      max_ruff_errors: 0

      # ---- Metadata (edit if needed) ----
      artifact_prefix: ''
      retention_days: 30
    secrets: inherit
