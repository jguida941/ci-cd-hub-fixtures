# Caller workflow to test reusable Python CI from hub
name: "Hub: Python CI (Reusable)"

on:
  workflow_dispatch:
  push:
    branches: [main, test-phase1b-schema]
    paths:
      - 'python-*/**'
  pull_request:
    branches: [main]
    paths:
      - 'python-*/**'

permissions:
  contents: read
  security-events: write

jobs:
  ci-passing:
    # NOTE: mutation_score_min=0 because mutmut is not detecting/running tests properly
    # TODO: Fix mutmut configuration and restore mutation_score_min=70
    name: "Python Passing"
    uses: jguida941/ci-cd-hub/.github/workflows/python-ci.yml@phase1b-workflow-schema
    with:
      python_version: '3.12'
      run_pytest: true
      run_ruff: true
      run_bandit: true
      run_pip_audit: true
      run_mypy: true
      run_black: true
      run_isort: true
      run_mutmut: true
      run_semgrep: true
      run_trivy: true
      run_docker: true
      run_codeql: true
      coverage_min: 70
      mutation_score_min: 0
      workdir: 'python-passing'
      artifact_prefix: 'python-passing-'
    secrets: inherit

  ci-failing:
    # NOTE: Relaxed thresholds so we can see all findings in ci-report
    # This fixture is expected to have issues - we want to verify detection
    # All tools run but with high thresholds to accept failures
    name: "Python Failing"
    uses: jguida941/ci-cd-hub/.github/workflows/python-ci.yml@phase1b-workflow-schema
    with:
      python_version: '3.12'
      run_pytest: true
      run_ruff: true
      run_bandit: true
      run_pip_audit: true
      run_mypy: true
      run_black: true
      run_isort: true
      run_mutmut: true
      run_semgrep: true
      run_trivy: true
      run_docker: true
      run_codeql: true
      coverage_min: 0
      mutation_score_min: 0
      max_critical_vulns: 999
      max_high_vulns: 999
      max_semgrep_findings: 999
      max_black_issues: 999
      max_isort_issues: 999
      max_ruff_errors: 999
      workdir: 'python-failing'
      artifact_prefix: 'python-failing-'
    secrets: inherit

  ci-docker:
    # Dedicated docker fixture - exercises Trivy container scan and Docker build
    # NOTE: Focus is Docker/Trivy testing, not code quality - relaxed thresholds
    name: "Python Docker"
    uses: jguida941/ci-cd-hub/.github/workflows/python-ci.yml@phase1b-workflow-schema
    with:
      python_version: '3.12'
      run_pytest: true
      run_ruff: true
      run_bandit: true
      run_pip_audit: true
      run_mypy: false
      run_black: true
      run_isort: true
      run_mutmut: false
      run_semgrep: true
      run_trivy: true
      run_docker: true
      run_codeql: false
      coverage_min: 70
      max_high_vulns: 10
      max_semgrep_findings: 10
      workdir: 'python-with-docker'
      artifact_prefix: 'python-docker-'
    secrets: inherit

  # ============================================================================
  # Report Validation - Passing Fixture
  # ============================================================================
  validate-passing:
    name: "Validate Passing Report"
    runs-on: ubuntu-latest
    needs: ci-passing
    if: always()
    steps:
      - name: Download Report
        uses: actions/download-artifact@v4
        with:
          name: python-passing-ci-report
          path: ./report

      - name: Validate Report Structure
        run: |
          REPORT="./report/report.json"
          ERRORS=0

          if [ ! -f "$REPORT" ]; then
            echo "::error::report.json not found"
            exit 1
          fi

          echo "=== Report Contents ==="
          cat "$REPORT"
          echo ""
          echo "=== Validation Checks ==="

          # 1. Schema version must be exactly "2.0"
          SCHEMA=$(jq -r '.schema_version // empty' "$REPORT")
          if [ "$SCHEMA" != "2.0" ]; then
            echo "::error::schema_version must be '2.0', got '$SCHEMA'"
            ERRORS=$((ERRORS + 1))
          else
            echo "✓ schema_version: $SCHEMA"
          fi

          # 2. Test results
          TESTS_PASSED=$(jq -r '.results.tests_passed // 0' "$REPORT")
          TESTS_FAILED=$(jq -r '.results.tests_failed // 0' "$REPORT")
          if [ "$TESTS_PASSED" -eq 0 ]; then
            echo "::error::tests_passed is 0 - expected tests to run"
            ERRORS=$((ERRORS + 1))
          else
            echo "✓ tests_passed: $TESTS_PASSED"
          fi
          if [ "$TESTS_FAILED" -gt 0 ]; then
            echo "::error::tests_failed ($TESTS_FAILED) > 0 - passing fixture should have no test failures"
            ERRORS=$((ERRORS + 1))
          else
            echo "✓ tests_failed: $TESTS_FAILED"
          fi

          # 3. Coverage >= 70%
          COVERAGE=$(jq -r '.results.coverage // 0' "$REPORT")
          if [ "$COVERAGE" -lt 70 ]; then
            echo "::error::coverage ($COVERAGE%) below 70% threshold"
            ERRORS=$((ERRORS + 1))
          else
            echo "✓ coverage: $COVERAGE%"
          fi

          # 4. ALL enabled tools must show tools_ran == true
          # Tools enabled in ci-passing job:
          echo ""
          echo "--- tools_ran checks (enabled tools for ci-passing) ---"
          for TOOL in pytest ruff bandit pip_audit mypy black isort mutmut semgrep trivy docker codeql; do
            RAN=$(jq -r ".tools_ran.$TOOL // false" "$REPORT")
            if [ "$RAN" != "true" ]; then
              echo "::error::tools_ran.$TOOL is $RAN - expected true (tool was enabled)"
              ERRORS=$((ERRORS + 1))
            else
              echo "✓ tools_ran.$TOOL: $RAN"
            fi
          done

          # 5. tool_metrics must be populated for enabled tools
          echo ""
          echo "--- tool_metrics checks (passing fixture = 0 issues) ---"
          RUFF_ERRORS=$(jq -r '.tool_metrics.ruff_errors // "null"' "$REPORT")
          BANDIT_HIGH=$(jq -r '.tool_metrics.bandit_high // "null"' "$REPORT")
          BANDIT_MEDIUM=$(jq -r '.tool_metrics.bandit_medium // "null"' "$REPORT")
          BLACK_ISSUES=$(jq -r '.tool_metrics.black_issues // "null"' "$REPORT")
          ISORT_ISSUES=$(jq -r '.tool_metrics.isort_issues // "null"' "$REPORT")
          SEMGREP_FINDINGS=$(jq -r '.tool_metrics.semgrep_findings // "null"' "$REPORT")

          # Check populated (not null)
          for METRIC in ruff_errors bandit_high bandit_medium black_issues isort_issues semgrep_findings; do
            VAL=$(jq -r ".tool_metrics.$METRIC // \"null\"" "$REPORT")
            if [ "$VAL" = "null" ]; then
              echo "::error::tool_metrics.$METRIC is null - should be populated"
              ERRORS=$((ERRORS + 1))
            fi
          done

          # For passing fixture: lint/security issues must be 0
          if [ "$RUFF_ERRORS" != "null" ] && [ "$RUFF_ERRORS" -gt 0 ]; then
            echo "::error::ruff_errors ($RUFF_ERRORS) > 0 - passing fixture should have no lint errors"
            ERRORS=$((ERRORS + 1))
          else
            echo "✓ ruff_errors: $RUFF_ERRORS"
          fi
          if [ "$BLACK_ISSUES" != "null" ] && [ "$BLACK_ISSUES" -gt 0 ]; then
            echo "::error::black_issues ($BLACK_ISSUES) > 0 - passing fixture should have no format issues"
            ERRORS=$((ERRORS + 1))
          else
            echo "✓ black_issues: $BLACK_ISSUES"
          fi
          if [ "$ISORT_ISSUES" != "null" ] && [ "$ISORT_ISSUES" -gt 0 ]; then
            echo "::error::isort_issues ($ISORT_ISSUES) > 0 - passing fixture should have no import issues"
            ERRORS=$((ERRORS + 1))
          else
            echo "✓ isort_issues: $ISORT_ISSUES"
          fi
          if [ "$BANDIT_HIGH" != "null" ] && [ "$BANDIT_HIGH" -gt 0 ]; then
            echo "::error::bandit_high ($BANDIT_HIGH) > 0 - passing fixture should have no high security issues"
            ERRORS=$((ERRORS + 1))
          else
            echo "✓ bandit_high: $BANDIT_HIGH"
          fi

          echo ""
          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Validation failed with $ERRORS errors"
            exit 1
          fi
          echo "=== Passing Fixture Validation Complete: All checks passed ==="

  # ============================================================================
  # Report Validation - Failing Fixture
  # ============================================================================
  validate-failing:
    name: "Validate Failing Report"
    runs-on: ubuntu-latest
    needs: ci-failing
    if: always()
    steps:
      - name: Download Report
        uses: actions/download-artifact@v4
        with:
          name: python-failing-ci-report
          path: ./report

      - name: Validate Report Structure
        run: |
          REPORT="./report/report.json"
          ERRORS=0

          if [ ! -f "$REPORT" ]; then
            echo "::error::report.json not found"
            exit 1
          fi

          echo "=== Report Contents ==="
          cat "$REPORT"
          echo ""
          echo "=== Validation Checks ==="

          # 1. Schema version must be exactly "2.0"
          SCHEMA=$(jq -r '.schema_version // empty' "$REPORT")
          if [ "$SCHEMA" != "2.0" ]; then
            echo "::error::schema_version must be '2.0', got '$SCHEMA'"
            ERRORS=$((ERRORS + 1))
          else
            echo "✓ schema_version: $SCHEMA"
          fi

          # 2. ALL enabled tools must show tools_ran == true
          # Tools enabled in ci-failing job:
          echo ""
          echo "--- tools_ran checks (enabled tools for ci-failing) ---"
          for TOOL in pytest ruff bandit pip_audit mypy black isort mutmut semgrep trivy docker codeql; do
            RAN=$(jq -r ".tools_ran.$TOOL // false" "$REPORT")
            if [ "$RAN" != "true" ]; then
              echo "::error::tools_ran.$TOOL is $RAN - expected true (tool was enabled)"
              ERRORS=$((ERRORS + 1))
            else
              echo "✓ tools_ran.$TOOL: $RAN"
            fi
          done

          # 3. tool_metrics must be populated (not null)
          echo ""
          echo "--- tool_metrics checks (must be populated) ---"
          for METRIC in ruff_errors bandit_high bandit_medium black_issues isort_issues semgrep_findings; do
            VAL=$(jq -r ".tool_metrics.$METRIC // \"null\"" "$REPORT")
            if [ "$VAL" = "null" ]; then
              echo "::error::tool_metrics.$METRIC is null - should be populated"
              ERRORS=$((ERRORS + 1))
            else
              echo "✓ tool_metrics.$METRIC: $VAL"
            fi
          done

          # 4. Failing fixture MUST detect issues - fail if no issues found
          echo ""
          echo "--- Issue detection checks (failing fixture must have issues) ---"
          BLACK_ISSUES=$(jq -r '.tool_metrics.black_issues // 0' "$REPORT")
          RUFF_ERRORS=$(jq -r '.tool_metrics.ruff_errors // 0' "$REPORT")
          BANDIT_HIGH=$(jq -r '.tool_metrics.bandit_high // 0' "$REPORT")
          BANDIT_MEDIUM=$(jq -r '.tool_metrics.bandit_medium // 0' "$REPORT")

          # Black MUST detect formatting issues in failing fixture
          if [ "$BLACK_ISSUES" -eq 0 ]; then
            echo "::error::black_issues is 0 - failing fixture MUST have formatting issues"
            ERRORS=$((ERRORS + 1))
          else
            echo "✓ black_issues: $BLACK_ISSUES (issues detected as expected)"
          fi

          # Ruff should detect issues
          if [ "$RUFF_ERRORS" -eq 0 ]; then
            echo "::warning::ruff_errors is 0 - failing fixture should have lint issues"
          else
            echo "✓ ruff_errors: $RUFF_ERRORS (issues detected as expected)"
          fi

          # Bandit should detect security issues if present
          BANDIT_TOTAL=$((BANDIT_HIGH + BANDIT_MEDIUM))
          if [ "$BANDIT_TOTAL" -gt 0 ]; then
            echo "✓ bandit findings: high=$BANDIT_HIGH, medium=$BANDIT_MEDIUM (security issues detected)"
          else
            echo "::warning::No bandit findings - consider adding security issues to failing fixture"
          fi

          echo ""
          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Validation failed with $ERRORS errors"
            exit 1
          fi
          echo "=== Failing Fixture Validation Complete: All checks passed ==="

  # ============================================================================
  # Report Validation - Docker Fixture
  # ============================================================================
  validate-docker:
    name: "Validate Docker Report"
    runs-on: ubuntu-latest
    needs: ci-docker
    if: always()
    steps:
      - name: Download Report
        uses: actions/download-artifact@v4
        with:
          name: python-docker-ci-report
          path: ./report

      - name: Validate Report Structure
        run: |
          REPORT="./report/report.json"
          ERRORS=0

          if [ ! -f "$REPORT" ]; then
            echo "::error::report.json not found"
            exit 1
          fi

          echo "=== Report Contents ==="
          cat "$REPORT"
          echo ""
          echo "=== Validation Checks ==="

          # 1. Schema version must be exactly "2.0"
          SCHEMA=$(jq -r '.schema_version // empty' "$REPORT")
          if [ "$SCHEMA" != "2.0" ]; then
            echo "::error::schema_version must be '2.0', got '$SCHEMA'"
            ERRORS=$((ERRORS + 1))
          else
            echo "✓ schema_version: $SCHEMA"
          fi

          # 2. Test results
          TESTS_PASSED=$(jq -r '.results.tests_passed // 0' "$REPORT")
          if [ "$TESTS_PASSED" -eq 0 ]; then
            echo "::error::tests_passed is 0 - expected tests to run"
            ERRORS=$((ERRORS + 1))
          else
            echo "✓ tests_passed: $TESTS_PASSED"
          fi

          # 3. Coverage >= 70%
          COVERAGE=$(jq -r '.results.coverage // 0' "$REPORT")
          if [ "$COVERAGE" -lt 70 ]; then
            echo "::error::coverage ($COVERAGE%) below 70% threshold"
            ERRORS=$((ERRORS + 1))
          else
            echo "✓ coverage: $COVERAGE%"
          fi

          # 4. Enabled tools must show tools_ran == true
          # Docker fixture: pytest, ruff, bandit, pip_audit, black, isort, semgrep, trivy, docker (no mypy, mutmut, codeql)
          echo ""
          echo "--- tools_ran checks (enabled tools for ci-docker) ---"
          for TOOL in pytest ruff bandit pip_audit black isort semgrep trivy docker; do
            RAN=$(jq -r ".tools_ran.$TOOL // false" "$REPORT")
            if [ "$RAN" != "true" ]; then
              echo "::error::tools_ran.$TOOL is $RAN - expected true (tool was enabled)"
              ERRORS=$((ERRORS + 1))
            else
              echo "✓ tools_ran.$TOOL: $RAN"
            fi
          done

          # 5. Disabled tools should be false
          echo ""
          echo "--- tools_ran checks (disabled tools) ---"
          for TOOL in mypy mutmut codeql; do
            RAN=$(jq -r ".tools_ran.$TOOL // false" "$REPORT")
            echo "✓ tools_ran.$TOOL: $RAN (disabled)"
          done

          # 6. tool_metrics for enabled tools
          echo ""
          echo "--- tool_metrics checks ---"
          for METRIC in ruff_errors bandit_high bandit_medium black_issues isort_issues semgrep_findings trivy_critical trivy_high; do
            VAL=$(jq -r ".tool_metrics.$METRIC // \"null\"" "$REPORT")
            if [ "$VAL" = "null" ]; then
              echo "::error::tool_metrics.$METRIC is null - should be populated"
              ERRORS=$((ERRORS + 1))
            else
              echo "✓ tool_metrics.$METRIC: $VAL"
            fi
          done

          echo ""
          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Validation failed with $ERRORS errors"
            exit 1
          fi
          echo "=== Docker Fixture Validation Complete: All checks passed ==="
